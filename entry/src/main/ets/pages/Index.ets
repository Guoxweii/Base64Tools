import { Base64Util } from '../utils/Base64Util';
import { SecretBox } from '../components/SecretBox';
import pasteboard from '@ohos.pasteboard';
import promptAction from '@ohos.promptAction';
import { scanBarcode, scanCore } from '@kit.ScanKit';
import { BusinessError } from '@kit.BasicServicesKit';
import { abilityAccessCtrl, common, Permissions } from '@kit.AbilityKit';

@Entry
@Component
struct Index {
  @State inputText: string = '';
  @State outputText: string = '';
  @State outputKey: number = 0; 
  @State inputKey: number = 0;

  hideKeyboard(): void {
    focusControl.requestFocus('titleFocus');
  }

  handleEncrypt(): void {
    this.hideKeyboard();
    if (!this.inputText) return;
    
    animateTo({ duration: 300, curve: Curve.FastOutSlowIn }, () => {
      this.outputText = Base64Util.encode(this.inputText);
      this.outputKey = Date.now(); 
    });
  }

  handleDecrypt(): void {
    this.hideKeyboard();
    if (!this.inputText) return;

    animateTo({ duration: 300, curve: Curve.FastOutSlowIn }, () => {
      this.outputText = Base64Util.decode(this.inputText);
      this.outputKey = Date.now(); 
    });
  }

  handleClear(): void {
    this.hideKeyboard();
    animateTo({ duration: 200, curve: Curve.EaseOut }, () => {
      this.inputText = '';
      this.outputText = '';
      this.inputKey = Date.now(); 
      this.outputKey = Date.now() + 1; 
    });
  }

  handleCopyAndBurn(): void {
    this.hideKeyboard();
    if (!this.outputText) return;
    
    try {
      const systemPasteboard = pasteboard.getSystemPasteboard();
      const pasteData = pasteboard.createData(pasteboard.MIMETYPE_TEXT_PLAIN, this.outputText);
      
      systemPasteboard.setData(pasteData).then(() => {
        promptAction.showToast({
          message: 'ðŸ“‹ å·²å¤åˆ¶å¹¶é”€æ¯è®°å½•',
          duration: 2000,
          bottom: 200
        });
        this.handleClear();
      }).catch((err: Error) => {
        console.error('Copy failed:', err);
      });
    } catch (e) {
      console.error('Pasteboard error:', e);
    }
  }

  async requestCameraPermission(): Promise<boolean> {
    let atManager = abilityAccessCtrl.createAtManager();
    let context = getContext(this) as common.UIAbilityContext;
    try {
      let result = await atManager.requestPermissionsFromUser(context, ['ohos.permission.CAMERA']);
      if (result.authResults.length > 0 && result.authResults[0] === 0) {
        return true;
      }
      return false;
    } catch (err) {
      return false;
    }
  }

  async handleScan(): Promise<void> {
    this.hideKeyboard();
    const hasPermission = await this.requestCameraPermission();
    if (!hasPermission) return;

    let options: scanBarcode.ScanOptions = {
      scanTypes: [scanCore.ScanType.ALL],
      enableMultiMode: true,
      enableAlbum: true
    };
    try {
      scanBarcode.startScanForResult(getContext(this), options)
        .then((result: scanBarcode.ScanResult) => {
          if (result.originalValue) {
            this.inputText = result.originalValue;
          }
        })
        .catch((error: BusinessError) => {});
    } catch (error) {}
  }

  build() {
    Stack() {
      // 1. å…¨å±€èƒŒæ™¯
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('#F2F2F7') // iOS ç³»ç»Ÿç°
        .onClick(() => { this.hideKeyboard(); })

      Column() {
        // 2. æ ‡é¢˜åŒº
        Row() {
          Column() {
            Text('Base64 éšç§åŠ©æ‰‹')
              .id('titleFocus') 
              .focusable(true) 
              .defaultFocus(true) 
              .fontSize(24) // ç¨å¾®è°ƒå°ä¸€ç‚¹ï¼Œæ›´ç²¾è‡´
              .fontWeight(FontWeight.Bold)
              .fontColor('#1A1A1A')
              .margin({ bottom: 4 })
            
            Text('é˜…åŽå³ç„šçš„å®‰å…¨è½¬æ¢å·¥å…·')
              .fontSize(14)
              .fontColor('#8E8E93')
          }
          .alignItems(HorizontalAlign.Start)
          
          Blank()
          
          // å¯ä»¥æ”¾ä¸ªå°çš„ logo æˆ–è€…ç‰ˆæœ¬å·
          Text('v2.1')
            .fontSize(12)
            .fontColor('#C7C7CC')
            .padding({ top: 4 })
            .border({ width: 1, color: '#E5E5EA', radius: 4 })
            .padding({ left: 6, right: 6, top: 2, bottom: 2 })
        }
        .width('100%')
        .margin({ top: 48, bottom: 32 }) // å¢žåŠ åº•éƒ¨é—´è·
        .padding({ left: 4 })

        // 3. è¾“å…¥å¡ç‰‡ (é›†æˆå·¥å…·æ )
        SecretBox({
          content: $inputText,
          title: 'INPUT', 
          isInput: true,
          placeholder: 'åœ¨æ­¤è¾“å…¥å†…å®¹...',
          onScanClick: () => { this.handleScan() },
          onClearClick: () => { this.handleClear() } // ç»‘å®šæ¸…ç©ºé€»è¾‘
        })
        .key(`input_${this.inputKey}`)
        .margin({ bottom: 24 })

        // 4. è½¬æ¢æ“ä½œåŒº
        Row() {
           // åŠ å¯†æŒ‰é’® (è“è‰²èƒ¶å›Š)
           Button('åŠ å¯† (Base64)', { type: ButtonType.Normal, stateEffect: true })
            .onClick(() => { this.handleEncrypt() })
            .borderRadius(24)
            .backgroundColor('#007AFF') 
            .fontColor('#FFFFFF')
            .fontWeight(FontWeight.Medium)
            .layoutWeight(1)
            .height(48)
            .margin({ right: 16 })
            .shadow({ radius: 8, color: 'rgba(0, 122, 255, 0.25)', offsetY: 4 })

           // è§£å¯†æŒ‰é’® (ç™½è‰²èƒ¶å›Š)
           Button('è§£å¯†è¿˜åŽŸ', { type: ButtonType.Normal, stateEffect: true })
            .onClick(() => { this.handleDecrypt() })
            .borderRadius(24)
            .backgroundColor('#FFFFFF') 
            .fontColor('#007AFF') 
            .fontWeight(FontWeight.Medium)
            .layoutWeight(1)
            .height(48)
            .shadow({ radius: 8, color: 'rgba(0,0,0,0.05)', offsetY: 2 })
        }
        .width('100%')
        .margin({ bottom: 24 })

        // 5. ç»“æžœå¡ç‰‡
        if (this.outputText) {
          Column() {
            SecretBox({
              content: $outputText,
              title: 'RESULT',
              isInput: false,
              // ç»“æžœæ¡†ä¹Ÿæœ‰æ¸…ç©ºå’Œå¤åˆ¶
              onClearClick: () => { this.handleClear() }
            })
            .key(`output_${this.outputKey}`)
            
            // å¤åˆ¶é”€æ¯æŒ‰é’® (è½»é‡åŒ–è®¾è®¡)
            Button('å¤åˆ¶ç»“æžœå¹¶é”€æ¯', { type: ButtonType.Normal, stateEffect: true })
              .onClick(() => { this.handleCopyAndBurn() })
              .borderRadius(12)
              .backgroundColor('#FFEBEE') // æµ…çº¢èƒŒæ™¯
              .fontColor('#D32F2F') // æ·±çº¢æ–‡å­—
              .fontWeight(FontWeight.Bold)
              .width('100%')
              .height(48)
              .margin({ top: 16 })
          }
        }

      }
      .width('100%')
      .padding(20)
    }
    .width('100%')
    .height('100%')
  }
}
