import { Base64Util } from '../utils/Base64Util';
import { SecretBox } from '../components/SecretBox';
import pasteboard from '@ohos.pasteboard';
import promptAction from '@ohos.promptAction';
import { scanBarcode, scanCore } from '@kit.ScanKit';
import { BusinessError } from '@kit.BasicServicesKit';
import { abilityAccessCtrl, common, Permissions } from '@kit.AbilityKit';

@Entry
@Component
struct Index {
  @State inputText: string = '';
  @State outputText: string = '';
  @State outputKey: number = 0; 
  @State inputKey: number = 0;

  hideKeyboard(): void {
    focusControl.requestFocus('titleFocus');
  }

  handleEncrypt(): void {
    this.hideKeyboard();
    if (!this.inputText) return;
    
    animateTo({ duration: 300, curve: Curve.FastOutSlowIn }, () => {
      this.outputText = Base64Util.encode(this.inputText);
      this.outputKey = Date.now(); 
    });
  }

  handleDecrypt(): void {
    this.hideKeyboard();
    if (!this.inputText) return;

    animateTo({ duration: 300, curve: Curve.FastOutSlowIn }, () => {
      this.outputText = Base64Util.decode(this.inputText);
      this.outputKey = Date.now(); 
    });
  }

  handleClear(): void {
    this.hideKeyboard();
    animateTo({ duration: 200, curve: Curve.EaseOut }, () => {
      this.inputText = '';
      this.outputText = '';
      this.inputKey = Date.now(); 
      this.outputKey = Date.now() + 1; 
    });
  }

  handleCopyAndBurn(): void {
    this.hideKeyboard();
    if (!this.outputText) return;
    
    try {
      const systemPasteboard = pasteboard.getSystemPasteboard();
      const pasteData = pasteboard.createData(pasteboard.MIMETYPE_TEXT_PLAIN, this.outputText);
      
      systemPasteboard.setData(pasteData).then(() => {
        promptAction.showToast({
          message: 'ğŸ“‹ å·²å¤åˆ¶å¹¶é”€æ¯è®°å½•',
          duration: 2000,
          bottom: 200
        });
        this.handleClear();
      }).catch((err: Error) => {
        console.error('Copy failed:', err);
      });
    } catch (e) {
      console.error('Pasteboard error:', e);
    }
  }

  async requestCameraPermission(): Promise<boolean> {
    let atManager = abilityAccessCtrl.createAtManager();
    let context = getContext(this) as common.UIAbilityContext;
    try {
      let result = await atManager.requestPermissionsFromUser(context, ['ohos.permission.CAMERA']);
      if (result.authResults.length > 0 && result.authResults[0] === 0) {
        return true;
      }
      return false;
    } catch (err) {
      return false;
    }
  }

  async handleScan(): Promise<void> {
    this.hideKeyboard();
    const hasPermission = await this.requestCameraPermission();
    if (!hasPermission) return;

    let options: scanBarcode.ScanOptions = {
      scanTypes: [scanCore.ScanType.ALL],
      enableMultiMode: true,
      enableAlbum: true
    };
    try {
      scanBarcode.startScanForResult(getContext(this), options)
        .then((result: scanBarcode.ScanResult) => {
          if (result.originalValue) {
            this.inputText = result.originalValue;
          }
        })
        .catch((error: BusinessError) => {});
    } catch (error) {}
  }

  build() {
    Stack() {
      // 1. å…¨å±€èƒŒæ™¯
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor($r('app.color.page_background')) // iOS ç³»ç»Ÿç°
        .onClick(() => { this.hideKeyboard(); })

      // 2. å¯æ»šåŠ¨çš„å†…å®¹åŒºåŸŸ
      Scroll() {
        Column() {
          // 2.1 æ ‡é¢˜åŒº
          Row() {
            Column() {
              Text('Base64 éšç§åŠ©æ‰‹')
                .id('titleFocus') 
                .focusable(true) 
                .defaultFocus(true) 
                .fontSize(24) // ç¨å¾®è°ƒå°ä¸€ç‚¹ï¼Œæ›´ç²¾è‡´
                .fontWeight(FontWeight.Bold)
                .fontColor($r('app.color.text_primary'))
                .margin({ bottom: 4 })
              
              Text('é˜…åå³ç„šçš„å®‰å…¨è½¬æ¢å·¥å…·')
                .fontSize(14)
                .fontColor($r('app.color.text_secondary'))
            }
            .alignItems(HorizontalAlign.Start)
            
            Blank()
            
            // å¯ä»¥æ”¾ä¸ªå°çš„ logo æˆ–è€…ç‰ˆæœ¬å·
            Text('v1.0beta')
              .fontSize(10)
              .fontColor($r('app.color.text_secondary'))
              .backgroundColor($r('app.color.sub_button_background'))
              .padding({ left: 8, right: 8, top: 4, bottom: 4 })
              .borderRadius(10)
              .fontWeight(FontWeight.Medium)
          }
          .width('100%')
          .margin({ top: 48, bottom: 32 }) // å¢åŠ åº•éƒ¨é—´è·
          .padding({ left: 4 })

          // 2.2 è¾“å…¥å¡ç‰‡ (é›†æˆå·¥å…·æ )
          SecretBox({
            content: $inputText,
            title: 'INPUT', 
            isInput: true,
            placeholder: 'åœ¨æ­¤è¾“å…¥å†…å®¹...',
            onScanClick: () => { this.handleScan() },
            onClearClick: () => { this.handleClear() } // ç»‘å®šæ¸…ç©ºé€»è¾‘
          })
          .key(`input_${this.inputKey}`)
          .margin({ bottom: 24 })

          // 2.3 è½¬æ¢æ“ä½œåŒº
          Row() {
             // åŠ å¯†æŒ‰é’® (è“è‰²èƒ¶å›Š)
             Button('åŠ å¯† (Base64)', { type: ButtonType.Normal, stateEffect: true })
              .onClick(() => { this.handleEncrypt() })
              .borderRadius(24)
              .linearGradient({
                  angle: 135,
                  colors: [[$r('app.color.brand_primary'), 0.0], [$r('app.color.brand_primary_dark'), 1.0]]
              })
              .fontColor($r('app.color.text_white'))
              .fontWeight(FontWeight.Medium)
              .layoutWeight(1)
              .height(48)
              .margin({ right: 16 })
              .shadow({ radius: 8, color: $r('app.color.shadow_primary'), offsetY: 4 })

             // è§£å¯†æŒ‰é’® (ç™½è‰²èƒ¶å›Š)
             Button('è§£å¯†è¿˜åŸ', { type: ButtonType.Normal, stateEffect: true })
              .onClick(() => { this.handleDecrypt() })
              .borderRadius(24)
              .backgroundColor($r('app.color.card_background')) 
              .fontColor($r('app.color.brand_primary')) 
              .fontWeight(FontWeight.Medium)
              .layoutWeight(1)
              .height(48)
              .shadow({ radius: 8, color: $r('app.color.shadow_normal'), offsetY: 2 })
          }
          .width('100%')
          .margin({ bottom: 24 })

          // 2.4 ç»“æœå¡ç‰‡
          if (this.outputText) {
            Column() {
              SecretBox({
                content: $outputText,
                title: 'RESULT',
                isInput: false,
                // ç»“æœæ¡†ä¹Ÿæœ‰æ¸…ç©ºå’Œå¤åˆ¶
                 onClearClick: () => { this.handleClear() }
              })
              .key(`output_${this.outputKey}`)
              
              // åº•éƒ¨æŒ‰é’®ç»„
              Row({ space: 16 }) {
                // æ¸…ç©ºæŒ‰é’®
                Button({ type: ButtonType.Capsule, stateEffect: true }) {
                  Text('æ¸…ç©º')
                    .fontSize(16)
                    .fontColor($r('app.color.text_secondary'))
                    .fontWeight(FontWeight.Medium)
                }
                .onClick(() => { this.handleClear() })
                .backgroundColor($r('app.color.card_background'))
                .shadow({ radius: 8, color: $r('app.color.shadow_normal'), offsetY: 2 }) // Capsule æ—¶ border radius éœ€è¦å¾ˆå¤§ä»¥åŒ¹é…
                .layoutWeight(1)
                .height(48)
                  
                // å¤åˆ¶é”€æ¯æŒ‰é’®
                Button('å¤åˆ¶ç»“æœå¹¶é”€æ¯', { type: ButtonType.Capsule, stateEffect: true }) // æ”¹ä¸º Capsule
                  .onClick(() => { this.handleCopyAndBurn() })
                  .backgroundColor($r('app.color.danger_light_background')) 
                  .fontColor($r('app.color.brand_danger_dark')) 
                  .fontWeight(FontWeight.Bold)
                  .layoutWeight(1)
                  .height(48)
              }
              .width('100%')
              .margin({ top: 16 })
            }
          }
        }
        .width('100%')
        .padding(20)
      }
      .width('100%')
      .height('100%')
      .align(Alignment.Top)
      .scrollBar(BarState.Off)
    }
    .width('100%')
    .height('100%')
    .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM]) // å¼€å¯æ²‰æµ¸å¼ï¼Œå»¶ä¼¸è‡³çŠ¶æ€æ å’Œå¯¼èˆªæ¡
  }
}