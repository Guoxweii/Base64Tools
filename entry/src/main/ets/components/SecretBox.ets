import { curves } from '@kit.ArkUI';

@Component
export struct SecretBox {
  @Link @Watch('onContentChange') content: string;
  @State isBlurred: boolean = true;
  @State viewCount: number = 0;
  @State isLocked: boolean = false;
  @State timeLeft: number = 0;
  
  private timerId: number = -1;
  private intervalId: number = -1;
  private maxViews: number = 3;
  private revealDuration: number = 3000;

  @Prop title: string;
  @Prop isInput: boolean = false; 
  @Prop placeholder: string = 'åœ¨æ­¤è¾“å…¥...';

  // å›žè°ƒ
  onCameraClick?: () => void;
  onScanClick?: () => void;
  onClearClick?: () => void;

  onContentChange() {
    this.viewCount = 0;
    this.isLocked = false;
    if (!this.isInput) {
      this.isBlurred = true;
      this.clearTimers();
      this.timeLeft = 0;
    }
  }

  aboutToAppear() {
    this.isBlurred = true;
  }

  aboutToDisappear() {
    this.clearTimers();
  }

  clearTimers() {
    if (this.timerId !== -1) {
      clearTimeout(this.timerId);
      this.timerId = -1;
    }
    if (this.intervalId !== -1) {
      clearInterval(this.intervalId);
      this.intervalId = -1;
    }
  }

  startReveal() {
    if (this.isLocked) return;
    if (!this.isBlurred) {
      this.hideContent();
      return;
    }
    if (this.viewCount >= this.maxViews) {
      this.isLocked = true;
      return;
    }

    this.isBlurred = false; 
    this.viewCount++;
    this.timeLeft = 100; 

    this.clearTimers();
    let step = 100 / (this.revealDuration / 30); 
    this.intervalId = setInterval(() => {
      this.timeLeft -= step;
      if (this.timeLeft <= 0) {
        this.timeLeft = 0;
        clearInterval(this.intervalId);
      }
    }, 30);

    this.timerId = setTimeout(() => {
      this.hideContent();
    }, this.revealDuration);
  }

  hideContent() {
    this.clearTimers();
    animateTo({ duration: 300, curve: Curve.FastOutSlowIn }, () => {
      this.isBlurred = true; 
      this.timeLeft = 0;
    });
    if (this.viewCount >= this.maxViews) {
      this.isLocked = true;
    }
  }

  // === æžç®€å‡ ä½•å›¾æ ‡ ===
  
  // 1. æŸ¥çœ‹å›¾æ ‡ (Eye)
  @Builder IconReveal(color: string) {
    Stack() {
      Circle()
        .width(20)
        .height(20)
        .fillOpacity(0) 
        .stroke(color)
        .strokeWidth(2)
      
      Circle()
        .width(8)
        .height(8)
        .fill(color)
    }
    .width(24)
    .height(24)
  }

  // 2. éšè—å›¾æ ‡ (Minus)
  @Builder IconHide(color: string) {
    Stack({ alignContent: Alignment.Center }) {
      Circle()
        .width(20)
        .height(20)
        .fillOpacity(0)
        .stroke(color)
        .strokeWidth(2)
      
      Rect()
        .width(10)
        .height(2)
        .fill(color)
        .radius(1)
    }
    .width(24)
    .height(24)
  }

  // 3. é”å®šå›¾æ ‡ (Lock)
  @Builder IconLock(color: string) {
    Stack({ alignContent: Alignment.Bottom }) {
      Circle()
        .width(14)
        .height(14)
        .fillOpacity(0)
        .stroke(color)
        .strokeWidth(2)
        .margin({ bottom: 10 })
      
      Rect()
        .width(16)
        .height(11)
        .fill(color)
        .radius(2)
    }
    .width(24)
    .height(24)
    .alignContent(Alignment.Bottom)
  }

  build() {
    Column() {
      Stack({ alignContent: Alignment.TopStart }) {
        if (this.isInput) {
           TextInput({ 
              text: this.content, 
              placeholder: this.placeholder 
            })
              .type(this.isBlurred ? InputType.Password : InputType.Normal)
              .showPasswordIcon(false) 
              .fontSize(16)
              .fontColor('#333333')
              .placeholderColor('#CCCCCC')
              .caretColor('#007AFF')
              .backgroundColor(Color.Transparent)
              .width('100%')
              .height('100%') 
              .padding({ left: 16, right: 16 })
              .onChange((value: string) => {
                this.content = value;
              })
        } else {
          Scroll() {
            Text(this.content)
              .fontSize(16)
              .fontColor('#333333')
              .lineHeight(24)
              .width('100%')
              .padding(16)
              .visibility(this.isBlurred ? Visibility.Hidden : Visibility.Visible)
          }
          .width('100%')
          .height('100%') 
          .align(Alignment.TopStart)
        }

        if (this.isBlurred && !this.isInput) {
          Stack() {
            Rect()
              .width('100%')
              .height('100%')
              .fill('rgba(255, 255, 255, 0.95)') 
              .backdropBlur(0) 
            
            Column({ space: 12 }) {
              if (this.isLocked) {
                 this.IconLock('#FF3B30')
              } else {
                 this.IconLock('#007AFF') 
              }
              
              if (this.isLocked) {
                 Text('å†…å®¹å·²é”€æ¯')
                  .fontSize(14)
                  .fontColor('#FF3B30')
                  .fontWeight(FontWeight.Medium)
              } else {
                 Text('ç‚¹å‡»æŸ¥çœ‹éšè—å†…å®¹')
                  .fontSize(14)
                  .fontColor('#8E8E93')
              }
            }
          }
          .width('100%')
          .height('100%') 
          .onClick(() => {
            this.startReveal();
          })
        }
      }
      .width('100%')
      .height(140) 
      .animation({ duration: 300, curve: Curve.FastOutSlowIn })

      // === è¿›åº¦æ¡ ===
      if (this.timeLeft > 0 && !this.isBlurred) {
        Progress({ value: this.timeLeft, total: 100, type: ProgressType.Linear })
          .width('100%')
          .height(2)
          .color('#007AFF') 
          .backgroundColor('#F5F5F5')
      } else {
        Divider()
          .color('#F5F5F5')
          .width('100%')
          .strokeWidth(1)
      }

      // === åº•éƒ¨å·¥å…·æ  ===
      Row() {
        if (this.isLocked) {
           Text('æ— æ³•è®¿é—®')
             .fontSize(12)
             .fontColor('#FF3B30')
        } else {
           Row({ space: 6 }) { 
             ForEach([1, 2, 3], (index: number) => {
               Circle()
                 .width(6)
                 .height(6)
                 // ä¼˜åŒ–ï¼šæœªæ¿€æ´»çŠ¶æ€é¢œè‰²åŠ æ·±åˆ° #C7C7CC
                 .fill(index > this.viewCount ? '#007AFF' : '#C7C7CC') 
             })
           }
        }

        Blank()

        Row({ space: 0 }) {
          if (this.isInput && !this.isLocked && this.onScanClick) {
             Button({ type: ButtonType.Normal }) {
               Text('â›¶').fontSize(18).fontColor('#555555').textAlign(TextAlign.Center)
             }
             .width(44).height(44).backgroundColor('transparent').borderRadius(8)
             .onClick(() => { if(this.onScanClick) this.onScanClick() })
          }
          
          if (this.isInput && !this.isLocked && this.onCameraClick) {
             Button({ type: ButtonType.Normal }) {
               Text('ðŸ“·').fontSize(18).fontColor('#555555').textAlign(TextAlign.Center)
             }
             .width(44).height(44).backgroundColor('transparent').borderRadius(8)
             .onClick(() => { if(this.onCameraClick) this.onCameraClick() })
          }
          
          if (this.content && !this.isLocked) {
             Button({ type: ButtonType.Normal }) {
               Text('ðŸ—‘ï¸').fontSize(18).fontColor('#FF3B30').textAlign(TextAlign.Center)
             }
             .width(44).height(44).backgroundColor('transparent').borderRadius(8)
             .onClick(() => { 
                if (this.onClearClick) this.onClearClick();
                else this.content = ''; 
             })
          }
          
          Button({ type: ButtonType.Normal }) {
            if (this.isBlurred) {
              this.IconReveal('#007AFF')
            } else {
              this.IconHide('#8E8E93')
            }
          }
          .width(44)
          .height(44)
          .backgroundColor('transparent')
          .borderRadius(8)
          .onClick(() => {
             this.startReveal();
          })
        }
        .alignItems(VerticalAlign.Center)
      }
      .width('100%')
      .height(48)
      .padding({ left: 16, right: 8 })
      .backgroundColor('#FAFAFA') 
      .borderRadius({ bottomLeft: 16, bottomRight: 16 }) 
      .alignItems(VerticalAlign.Center)
    }
    .width('100%')
    .backgroundColor('#FFFFFF') 
    .borderRadius(16)
    .shadow({ radius: 10, color: 'rgba(0,0,0,0.05)', offsetY: 2 })
    .clip(true) 
  }
}
